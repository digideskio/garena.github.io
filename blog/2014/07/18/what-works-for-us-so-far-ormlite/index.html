
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->

<head>


<meta charset="utf-8">
<meta http-equiv="cleartype" content="on">

<title>What Works for Us So Far - Ormlite - Engineering @ garena</title>
<meta name="author" content="Garena Labs">




<meta name="description" content="A Tech Blog by Garena Labs">

<meta name="keywords" content="android beetalk ">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Twitter Cards -->

  
    <meta name="twitter:card" content="summary">
    <meta name="twitter:image" content"">
  
  <meta name="twitter:title" content="What works for us so far - Ormlite">
  <meta name="twitter:description" content="A Tech Blog by Garena Labs">
  <meta name="twitter:creator" content="@Garena_SG">


<!-- Open Graph -->
<meta property="og:local" content="en_US">
<meta property="og:type" content="article">
<meta property="og:url" content="http://garena.github.io/blog/2014/07/18/what-works-for-us-so-far-ormlite">
<meta property="og:title" content="What works for us so far - Ormlite">
<meta property="og:description" content="A Tech Blog by Garena Labs">

  <meta property="og:image" content="">

<meta property="og:site_name" content="Engineering @ garena">

<link rel="canonical" href="http://garena.github.io/blog/2014/07/18/what-works-for-us-so-far-ormlite">
<link href="/favicon.png" rel="icon">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
<link href="/atom.xml" rel="alternate" title="Engineering @ garena" type="application/atom+xml">

<script src="/javascripts/modernizr.min.js"></script>



<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">


</head>

<body id="post" >

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="/">Home</a></li>
		<li><a href="/career">Career</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="" alt="Garena Labs photo" class="author-photo">
					<h4>Garena Labs</h4>
					<p></p>
				</li>
				<li><a href="//www.zimmerman.io">Learn More</a></li>
				
				<li>
					<a href="http://twitter.com/Garena_SG"><i class="fa fa-twitter"></i> Twitter</a>
				</li>
				
				<li>
					<a href="http://github.com/garena"><i class="fa fa-github"></i> GitHub</a>
				</li>
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="/posts/">All Posts</a></li>
				<li><a href="/categories/">All Categories</a></li>
			</ul>
		</li>
		
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->




<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title"><a href="/blog/2014/07/18/what-works-for-us-so-far-ormlite/" rel="bookmark" title="What works for us so far - Ormlite">What works for us so far - Ormlite</a></h1>
        
        <h2>July 18, 2014</h2>
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <h3><a href="http://ormlite.com/sqlite_java_android_orm.shtml">Ormlite</a></h3>

<p>Ormlite is the our choice of database ORM. Although we have decided to stick to it for new Android applications, there are quite a few thing missing in the manual.</p>

<h3>Name the Database</h3>

<p>Normally you name the databas with user ID like this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">String</span> <span class="n">databaseName</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;user_%d.db&quot;</span><span class="o">,</span> <span class="n">mUserId</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then you are screwed because you don&rsquo;t speak Persian/Arabian. In some languages, you cannot expect one as <code>1</code> and this <a href="http://en.wikipedia.org/wiki/Eastern_Arabic_numerals">wiki post</a> will show you a new way to write numbers. You can reproduce this issue by switching the locale to Arabic on the phone and you must stay clam if the app cannot find the database. The fix is simple, just specify the locale when formatting the string.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">String</span> <span class="n">databaseName</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">Locale</span><span class="o">.</span><span class="na">ENGLISH</span><span class="o">,</span><span class="s">&quot;user_%d.db&quot;</span><span class="o">,</span> <span class="n">mUserId</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<!-- more -->


<h3>Name the Column</h3>

<p>Well, you have the database now and go ahead to create tables. Take the example from the website:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@DatabaseTable</span><span class="o">(</span><span class="n">tableName</span> <span class="o">=</span> <span class="s">&quot;accounts&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Account</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@DatabaseField</span><span class="o">(</span><span class="n">id</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@DatabaseField</span><span class="o">(</span><span class="n">canBeNull</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">Account</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="c1">// all persisted classes must define a no-arg constructor with at least package visibility</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you are going to run proguard, then you may be screwed because the column changes. There are two solutions to this, either naming the columb explicitly or make all database object class excluded from proguard, as shown below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">APPROACH</span> <span class="n">ONE</span> <span class="o">-</span> <span class="n">Name</span> <span class="n">the</span> <span class="n">column</span> <span class="n">explicitly</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@DatabaseTable</span><span class="o">(</span><span class="n">tableName</span> <span class="o">=</span> <span class="s">&quot;accounts&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Account</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@DatabaseField</span><span class="o">(</span><span class="n">id</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span><span class="n">columnName</span> <span class="o">=</span> <span class="s">&quot;name&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@DatabaseField</span><span class="o">(</span><span class="n">canBeNull</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">columnName</span> <span class="o">=</span> <span class="s">&quot;password&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">Account</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="c1">// all persisted classes must define a no-arg constructor with at least package visibility</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">APPROACH</span> <span class="n">TWO</span> <span class="o">-</span> <span class="n">Modify</span> <span class="n">the</span> <span class="n">proguard</span> <span class="n">file</span>
</span><span class='line'>
</span><span class='line'><span class="o">-</span><span class="n">keep</span> <span class="kd">class</span> <span class="nc">com</span><span class="o">.</span><span class="na">XXXXXX</span><span class="o">.</span><span class="na">bean</span><span class="o">.**{*;}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Are those results cached?</h3>

<p>Now you have the table and it is time to query the data out from the database. ORM generally makes your life easier but it does not mean that the app can get the data with ease. Ormlite claims that the result is cached but you have to do the homework yourself by following <a href="http://ormlite.com/javadoc/ormlite-core/doc-files/ormlite_5.html#Object-Caches">this guide</a>.</p>

<p>However it only works for 4.48+, in 4.46, you may write code like this</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="n">mUserDao</span> <span class="o">=</span> <span class="n">DaoManager</span><span class="o">.</span><span class="na">createDao</span><span class="o">(</span><span class="n">getConnectionSource</span><span class="o">(),</span> <span class="n">UserInfo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'> <span class="n">mUserDao</span><span class="o">.</span><span class="na">setObjectCache</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>And we guarantee that it does NOT work at all.</p>

<h3>Update the table</h3>

<p>Database scheme always changes because PM always changes their mind.</p>

<p>OrmLite provides callback for you to decide how to upgrade.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onUpgrade</span><span class="o">(</span><span class="n">SQLiteDatabase</span> <span class="n">sqLiteDatabase</span><span class="o">,</span> <span class="n">ConnectionSource</span> <span class="n">connectionSource</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">oldVersion</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">newVersion</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">newVersion</span> <span class="o">&gt;</span> <span class="n">oldVersion</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>         <span class="c1">//run upgrade</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We follow this guide <a href="http://ormlite.com/javadoc/ormlite-core/doc-files/ormlite_4.html#Upgrading-Schema">here</a> and we were happy until PM changes his mind on how to contact the customers.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="k">if</span> <span class="o">(</span><span class="n">oldVersion</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">newVersion</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">TableUtils</span><span class="o">.</span><span class="na">createTableIfNotExists</span><span class="o">(</span><span class="n">connectionSource</span><span class="o">,</span> <span class="n">Customer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'> <span class="o">...</span><span class="c1">//A lot of thing happens here</span>
</span><span class='line'>
</span><span class='line'> <span class="k">if</span> <span class="o">(</span><span class="n">oldVersion</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="o">&amp;&amp;</span> <span class="n">newVersion</span> <span class="o">&gt;=</span> <span class="mi">12</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">dao</span><span class="o">.</span><span class="na">executeRaw</span><span class="o">(</span><span class="s">&quot;ALTER TABLE `customer` ADD COLUMN contact_number VARCHAR DEFAULT ``;&quot;</span><span class="o">);</span>
</span><span class='line'> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We were screwed because the app could not complete the upgrade after upgrade. The issue here is that you should not use <code>createTableIfNotExists</code> to update the database. Let&rsquo;s assume that the user wants to upgrade his database from version 7 to version 8. He gonna hit the 1st statement to create the database and before the 2nd statement runs, he already has the column named <em>customer</em>. The definition of <em>Customer</em> changes over time! You should always write raw query to update the database becuase the query won&rsquo;t change.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="k">if</span> <span class="o">(</span><span class="n">oldVersion</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">newVersion</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">dao</span><span class="o">.</span><span class="na">executeRaw</span><span class="o">(</span><span class="s">&quot;CREATE TABLE `customer` ......&quot;</span><span class="o">);</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'> <span class="o">...</span><span class="c1">//A lot of thing happens here</span>
</span><span class='line'>
</span><span class='line'> <span class="k">if</span> <span class="o">(</span><span class="n">oldVersion</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="o">&amp;&amp;</span> <span class="n">newVersion</span> <span class="o">&gt;=</span> <span class="mi">12</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">dao</span><span class="o">.</span><span class="na">executeRaw</span><span class="o">(</span><span class="s">&quot;ALTER TABLE `customer` ADD COLUMN contact_number VARCHAR DEFAULT ``;&quot;</span><span class="o">);</span>
</span><span class='line'> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Besides OrmLite, there are plenty of options out there and we have not got a chance to get hands on them. We are interested to explore <a href="http://sqlcipher.net/">SQLCipher</a> in the near future.</p>

      <footer class="entry-meta">
        <span class="entry-tags"><a href="/categories/#android" title="Pages tagged android" class="tag">android</a><a href="/categories/#beetalk" title="Pages tagged beetalk" class="tag">beetalk</a></span>
        <span><a href="/blog/2014/07/18/what-works-for-us-so-far-ormlite/" rel="bookmark" title="What works for us so far - Ormlite">What works for us so far - Ormlite</a> was published on <span class="entry-date date published updated"><time datetime="2014-07-18T13:33:30+08:00">July 18, 2014</time></span></span>
        
        <span class="author vcard"><span class="fn"><a href="/zhao-cong" title="About Zhao Cong">Zhao Cong</a></span></span>
        
      </footer>
    </div><!-- /.entry-content -->
    
      <div class="read-more">
        
          <div class="read-more-header">
            <a href="/blog/2015/10/15/memory-leak-caused-by-drawable-in-gingerbread/" class="btn">Read More</a>
          </div><!-- /.read-more-header -->
          <div class="read-more-content">
            <h3><a href="/blog/2015/10/15/memory-leak-caused-by-drawable-in-gingerbread/" title="Memory Leak caused by Drawable in Gingerbread">Memory Leak caused by Drawable in Gingerbread</a></h3>
            <p>In the previous [post](/blog/2014/09/10/android-memory-leaks/), we have briefly introduced memory leak in Android. Memory leak is one of &hellip;&hellip; <a href="/blog/2015/10/15/memory-leak-caused-by-drawable-in-gingerbread/"> Continue reading</a></p>
          </div><!-- /.read-more-content -->
        
        <div class="read-more-list">
          
            <div class="list-item">
              <h4><a href="/blog/2015/10/13/hello-marshmallow-runtime-runtime-permission/" title="Hello Marshmallow - Runtime Permission">Hello Marshmallow - Runtime Permission</a></h4>
              <span>Published on October 13, 2015</span>
            </div><!-- /.list-item -->
          
            <div class="list-item">
              <h4><a href="/blog/2015/05/24/a-shot-of-espresso/" title="A Shot of Espresso">A Shot of Espresso</a></h4>
              <span>Published on May 24, 2015</span>
            </div><!-- /.list-item -->
          
        </div><!-- /.read-more-list -->
      </div><!-- /.read-more -->
    
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2015 Garena Labs. Powered by <a href="http://octopress.org">Octopress</a> using the <a href="https://github.com/Z1MM32M4N/hpstr-theme/">HPSTR Theme for Octopress</a>.</span>

  </footer>
</div><!-- /.footer-wrapper -->


	        
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/javascripts/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<!--
<script src="/javascripts/octopress.js" type="text/javascript"></script>
-->
<script src="/javascripts/scripts.min.js"></script>

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-53779472-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>




<script type="text/javascript">
      var disqus_shortname = 'garenalabs';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://garena.github.io/blog/2014/07/18/what-works-for-us-so-far-ormlite/';
        var disqus_url = 'http://garena.github.io/blog/2014/07/18/what-works-for-us-so-far-ormlite/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


	        

</body>
</html>
