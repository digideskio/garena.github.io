
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->

<head>


<meta charset="utf-8">
<meta http-equiv="cleartype" content="on">

<title>A Tech Blog by Garena Labs - Engineering @ garena</title>
<meta name="author" content="Garena Labs">




<meta name="description" content="Chronicles of Software Adventure at Garena">

<meta name="keywords" content="Jekyll theme themes responsive blog modern tech hacks ">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Twitter Cards -->

  
    <meta name="twitter:card" content="summary">
    <meta name="twitter:image" content"">
  
  <meta name="twitter:title" content="A Tech Blog by Garena Labs">
  <meta name="twitter:description" content="Chronicles of Software Adventure at Garena">
  <meta name="twitter:creator" content="@Garena_SG">


<!-- Open Graph -->
<meta property="og:local" content="en_US">
<meta property="og:type" content="article">
<meta property="og:url" content="http://garena.github.io">
<meta property="og:title" content="A Tech Blog by Garena Labs">
<meta property="og:description" content="Chronicles of Software Adventure at Garena">

  <meta property="og:image" content="">

<meta property="og:site_name" content="Engineering @ garena">

<link rel="canonical" href="http://garena.github.io">
<link href="/favicon.png" rel="icon">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
<link href="/atom.xml" rel="alternate" title="Engineering @ garena" type="application/atom+xml">

<script src="/javascripts/modernizr.min.js"></script>



<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">


</head>

<body id="post-index" >
  <!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
  <nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="/">Home</a></li>
		<li><a href="/career">Career</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="" alt="Garena Labs photo" class="author-photo">
					<h4>Garena Labs</h4>
					<p></p>
				</li>
				<li><a href="//www.zimmerman.io">Learn More</a></li>
				
				<li>
					<a href="http://twitter.com/Garena_SG"><i class="fa fa-twitter"></i> Twitter</a>
				</li>
				
				<li>
					<a href="http://github.com/garena"><i class="fa fa-github"></i> GitHub</a>
				</li>
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="/posts/">All Posts</a></li>
				<li><a href="/categories/">All Categories</a></li>
			</ul>
		</li>
		
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->


  <div class="entry-header">
    
    
    <div class="header-title">
      <div class="header-title-wrap">
        <h1>Engineering @ garena</h1>
        <h2>Creating Software one app at a time</h2>
      </div><!-- /.header-title-wrap -->
    </div><!-- /.header-title -->
  </div><!-- /.entry-header -->

  <div id="main" role="main">
    

<article class="hentry">
  



<header>
  <div class="entry-meta">
    <span class="entry-date date published updated">
      <time datetime="2015-10-15T00:34:00+08:00">
        <a href="/blog/2015/10/15/memory-leak-caused-by-drawable-in-gingerbread/">October 15, 2015</a>
      </time>
    </span>
    <span class="author vcard">
      <span class="fn">
        <a href="" title="About "></a>
      </span>
    </span>
    
      &nbsp; &bull; &nbsp;<span class="entry-comments">
        <a href="/blog/2015/10/15/memory-leak-caused-by-drawable-in-gingerbread/#disqus_thread">Comment</a>
      </span>
    
  </div><!-- /.entry-meta -->
  
    <h1 class="entry-title">
      <a href="/blog/2015/10/15/memory-leak-caused-by-drawable-in-gingerbread/" rel="bookmark" title="Memory Leak Caused by Drawable in Gingerbread" itemprop="url">Memory Leak Caused by Drawable in Gingerbread</a>
    </h1>
  
</header>

<div class="entry-content">
  <p>In the previous <a href="/blog/2014/09/10/android-memory-leaks/">post</a>, we have briefly introduced memory leak in Android. Memory leak is one of the most important issues, we need to pay attention to during Android development. It may happen when we are unaware of it. In this post, we would like to share a scenario of memory leak in Gingerbread, which is diffcult to notice and observe.</p>

<h2>Scenario</h2>

<p>Firstly, let&rsquo;s take a look at a simple example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecondActivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
</span><span class='line'>        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_second</span><span class="o">);</span>
</span><span class='line'>        <span class="n">Drawable</span> <span class="n">drawable</span> <span class="o">=</span> <span class="n">DrawableLruCache</span><span class="o">.</span><span class="na">getInstance</span><span class="o">()</span>
</span><span class='line'>                <span class="o">.</span><span class="na">getDrawable</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">android_logo</span><span class="o">);</span>
</span><span class='line'>        <span class="n">ImageView</span> <span class="n">imageView</span> <span class="o">=</span> <span class="o">(</span><span class="n">ImageView</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">image_view</span><span class="o">);</span>
</span><span class='line'>        <span class="n">imageView</span><span class="o">.</span><span class="na">setImageDrawable</span><span class="o">(</span><span class="n">drawable</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This piece of code is very simple. In an Activity, we would like to get a Drawable from a LRU cache, and then show the Drawable in a ImageView inside the Activity. Could you figure out anything wrong with this piece of code?</p>

<p>Actually, this piece of code would cause memory leak in Gingerbread devices. When the Activity is destroyed, the LRU cache would likely continue to keep a strong reference of the Drawable, and the Drawable would still keep a strong reference of the View. Therefore, the whole Activity, as well as everything inside the Activity would be memory leaked.</p>

<h2>Reason</h2>

<p>The memory leak is caused by a small “bug” in the design of the Drawable object in Gingerbread.</p>

<p>In Android, all the Views implement the <code>Drawable.Callback</code> interface. This interface is required for the Views to support animated Drawable. Whenever we need to display the Drawable in the View, for instance when we calling <code>setImageDrawable(Drawable drawable)</code> in a ImageView, Android would set the view as the callback client of the Drawable, in order to allow the View to support animation for the Drawable. You may figure out the detail implementation of the method from the source code of Android <a href="http://grepcode.com/file/repository.grepcode.com/java/ext/com.google.android/android/4.2.1_r1.2/android/widget/ImageView.java#ImageView.setImageDrawable%28android.graphics.drawable.Drawable%29">here</a>.</p>

<p>However, according to the <a href="http://grepcode.com/file/repository.grepcode.com/java/ext/com.google.android/android/2.3.7_r1/android/graphics/drawable/Drawable.java#Drawable.setCallback%28android.graphics.drawable.Drawable.Callback%29">source code</a> of the Drawable, the Callback of the Drawable is passed as a strong reference in Gingerbread shown below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span>  <span class="nf">setCallback</span><span class="o">(</span><span class="n">Callback</span> <span class="n">cb</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">mCallback</span> <span class="o">=</span> <span class="n">cb</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>That means, whenever we want to display the Drawable to a View, the Drawable would keep a strong reference of the View. Therefore, even after the Activity or View is destroyed, the Drawable would still keep a strong reference to the View, which may cause memory leak.</p>

<p>You may think it is the LRU cache causes the memory leak. However, even if we do not use the LRU cache, this memory leak may still happen easily. The reason is that Android does have some kind of recycling manager with Drawable component. Therefore, when we get the Drawable with the same resource ID at different places, it is very common that Android would return the same instance of Drawable in order to optimize the usage of the memory.</p>

<p>In other words, even there is no LRU cache, the same Drawable may still be used by other components such as another ImageView in another Activity, as long as the other ImageView needs to show the same Drawable with the same resource ID. If the other ImageView exists in the memory, it would keep a strong reference of the Drawable. Consequently, the Drawable would keep a strong reference of the View and will cause the same memory leak.</p>

<h2>Solution</h2>

<p>In order to solve this kind of memory leak, what we need to do is to manually set the Callback to be <code>null</code> when <code>onDestory()</code> is called in the Activity, or when <code>onDetachedFromWindow()</code> is called for the specific View. The source code we used to unbind the Drawable from the root view of the Activity is shown below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">unbindDrawables</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">view</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">view</span><span class="o">.</span><span class="na">getBackground</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">view</span><span class="o">.</span><span class="na">getBackground</span><span class="o">().</span><span class="na">setCallback</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">view</span> <span class="k">instanceof</span> <span class="n">ImageView</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">ImageView</span> <span class="n">imgView</span> <span class="o">=</span> <span class="o">(</span><span class="n">ImageView</span><span class="o">)</span> <span class="n">view</span><span class="o">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">imgView</span><span class="o">.</span><span class="na">getDrawable</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Drawable</span> <span class="n">b</span> <span class="o">=</span> <span class="n">imgView</span><span class="o">.</span><span class="na">getDrawable</span><span class="o">();</span>
</span><span class='line'>            <span class="n">b</span><span class="o">.</span><span class="na">setCallback</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>            <span class="n">imgView</span><span class="o">.</span><span class="na">setImageDrawable</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">view</span> <span class="k">instanceof</span> <span class="n">ViewGroup</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">((</span><span class="n">ViewGroup</span><span class="o">)</span> <span class="n">view</span><span class="o">).</span><span class="na">getChildCount</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">unbindDrawables</span><span class="o">(((</span><span class="n">ViewGroup</span><span class="o">)</span> <span class="n">view</span><span class="o">).</span><span class="na">getChildAt</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">((</span><span class="n">view</span> <span class="k">instanceof</span> <span class="n">AdapterView</span><span class="o">&lt;?&gt;))</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">AdapterView</span><span class="o">&lt;?&gt;</span> <span class="n">adapterView</span> <span class="o">=</span> <span class="o">(</span><span class="n">AdapterView</span><span class="o">&lt;?&gt;)</span> <span class="n">view</span><span class="o">;</span>
</span><span class='line'>                <span class="n">adapterView</span><span class="o">.</span><span class="na">setAdapter</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                <span class="o">((</span><span class="n">ViewGroup</span><span class="o">)</span> <span class="n">view</span><span class="o">).</span><span class="na">removeAllViews</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>One more thing need to mention is that, this issue has already fixed in the Android Ice Cream Sandwich and above. In the
newer version of Android, the Callback would be passed as a <code>WeakReference</code> according to the source
code <a href="http://grepcode.com/file/repository.grepcode.com/java/ext/com.google.android/android/4.2.1_r1.2/android/graphics/drawable/Drawable.java#Drawable.setCallback%28android.graphics.drawable.Drawable.Callback%29">here</a>. Hence, if you are no longer supporting Gingerbread, you don’t need to care about this issue.</p>

  
  
</div><!-- /.entry-content -->





</article><!-- /.hentry -->

<article class="hentry">
  



<header>
  <div class="entry-meta">
    <span class="entry-date date published updated">
      <time datetime="2015-10-13T21:02:49+08:00">
        <a href="/blog/2015/10/13/hello-marshmallow-runtime-runtime-permission/">October 13, 2015</a>
      </time>
    </span>
    <span class="author vcard">
      <span class="fn">
        <a href="zhao-cong" title="About Zhao Cong">Zhao Cong</a>
      </span>
    </span>
    
      &nbsp; &bull; &nbsp;<span class="entry-comments">
        <a href="/blog/2015/10/13/hello-marshmallow-runtime-runtime-permission/#disqus_thread">Comment</a>
      </span>
    
  </div><!-- /.entry-meta -->
  
    <h1 class="entry-title">
      <a href="/blog/2015/10/13/hello-marshmallow-runtime-runtime-permission/" rel="bookmark" title="Hello Marshmallow - Runtime Permission" itemprop="url">Hello Marshmallow - Runtime Permission</a>
    </h1>
  
</header>

<div class="entry-content">
  <p>We never care about new release of Android operating system. Three reasons. Firstly, there were hardly any broken changes and the new operating system promised to be compatible with the legacy. Secondly, it took months for the non-Nexus user to get the OTA and the adaption for new OS happens in a slow pace, i.e. Lollipop only hits around 20% in the global Android distribution. Thirdly, we don&rsquo;t have enough manpower to bother with new OS and engineers is occupied by one feature after another. However, the new Android 6.0 really grab our attention since it broke two barriers: the new operating system introduces breaking changes with the new permission system and the slightly bigger team want to deal with it.</p>

<h2>Timeline</h2>

<p>OTA for Nexus devices kicks off at the first week of October 2015 and many more manufactures pledged their support by the end of 2015. So roughly we have <em>three months</em> to deal with the issues.</p>

<h2>What&rsquo;s happening?</h2>

<p>Quoted from <a href="https://developer.android.com/about/dashboards/index.html">offical dashboard</a>.</p>

<p><img src="/images/android-dashbord-2015-oct.png" alt="Official Dashboard" /></p>

<p>Our initial thoughts are</p>

<ul>
<li>Southeast Asia is in an older OS compared to the rest of the world.</li>
<li>The coverage of the latest OS is not significant in the countries we do business with.</li>
</ul>


<p>It turns out our assumptions do not hold at all. We choose one app which is being distributed in Thailand and get the distribution data from Google Play developer console. Apparently people in Thailand are not stick to old fashioned operating system and we should worry about what gonna happen in three months&#8217; time.</p>

<p><img src="/images/th-android-app-comparison.png" alt="Global VS Thailand" /></p>

<h2>What&rsquo;s new in Marshmallow?</h2>

<p>The full list can be found <a href="https://developer.android.com/about/versions/marshmallow/android-6.0-changes.html">here</a>. Two things get our attention:</p>

<ul>
<li>Runtime permission</li>
<li>Doze &amp; app standby</li>
</ul>


<p>This post will focus one Runtime Permission.</p>

<p>There are tons of resources about runtime permission.</p>

<ul>
<li><a href="https://www.youtube.com/watch?v=C8lUdPVSzDk">Video &ndash; Runtime permission</a></li>
<li><a href="https://www.youtube.com/watch?v=iZqDdvhTZj0">Video &ndash; Asking for Permission</a></li>
</ul>


<p>Well, we care about what is hidden under the hood.</p>

<h2>Permission or Permissions</h2>

<p>The documentation never specifies the behavior when you request permissions in one Permission Group. For example, you want to access the location so that you check the permission <code>ACCESS_FINE_LOCATION</code> and <code>ACCESS_COARSE_LOCATION</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="k">if</span> <span class="o">(</span><span class="n">ActivityCompat</span><span class="o">.</span><span class="na">checkSelfPermission</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">ACCESS_FINE_LOCATION</span><span class="o">)</span> <span class="o">!=</span> <span class="n">PackageManager</span><span class="o">.</span><span class="na">PERMISSION_GRANTED</span> <span class="o">||</span>
</span><span class='line'>                <span class="n">ActivityCompat</span><span class="o">.</span><span class="na">checkSelfPermission</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">ACCESS_COARSE_LOCATION</span><span class="o">)</span> <span class="o">!=</span> <span class="n">PackageManager</span><span class="o">.</span><span class="na">PERMISSION_GRANTED</span><span class="o">){</span>
</span><span class='line'>            <span class="c1">// location permissions have not been granted.</span>
</span><span class='line'>            <span class="n">requestLocationPermission</span><span class="o">();</span>
</span><span class='line'>            <span class="k">return</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then you ask for permission.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span><span class="o">[]</span> <span class="n">PERMISSIONS_LOCATION</span> <span class="o">=</span> <span class="o">{</span><span class="n">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">ACCESS_FINE_LOCATION</span><span class="o">,</span> <span class="n">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">ACCESS_COARSE_LOCATION</span><span class="o">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">requestLocationPermission</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">ActivityCompat</span><span class="o">.</span><span class="na">shouldShowRequestPermissionRationale</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">ACCESS_FINE_LOCATION</span><span class="o">)){</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Provide an additional rationale to the user if the permission was not granted</span>
</span><span class='line'>        <span class="c1">// and the user would benefit from additional context for the use of the permission.</span>
</span><span class='line'>        <span class="c1">// For example, if the request has been denied previously.</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Display a SnackBar with an explanation and a button to trigger the request.</span>
</span><span class='line'>        <span class="n">Snackbar</span><span class="o">.</span><span class="na">make</span><span class="o">(</span><span class="n">mainLayout</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">track_down_wherever_you_are</span><span class="o">,</span> <span class="n">Snackbar</span><span class="o">.</span><span class="na">LENGTH_INDEFINITE</span><span class="o">)</span>
</span><span class='line'>                <span class="o">.</span><span class="na">setAction</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">ok</span><span class="o">,</span> <span class="k">new</span> <span class="n">View</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                    <span class="nd">@Override</span>
</span><span class='line'>                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                        <span class="n">ActivityCompat</span><span class="o">.</span><span class="na">requestPermissions</span><span class="o">(</span><span class="n">HomeActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">PERMISSIONS_LOCATION</span><span class="o">,</span>
</span><span class='line'>                                <span class="n">ACCESS_LOCATION_PERMISSION_REQUEST_CODE</span><span class="o">);</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">})</span>
</span><span class='line'>                <span class="o">.</span><span class="na">show</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// Contact permissions have not been granted yet. Request them directly.</span>
</span><span class='line'>        <span class="n">ActivityCompat</span><span class="o">.</span><span class="na">requestPermissions</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">PERMISSIONS_LOCATION</span><span class="o">,</span> <span class="n">ACCESS_LOCATION_PERMISSION_REQUEST_CODE</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>and we implement the callbacks</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRequestPermissionsResult</span><span class="o">(</span><span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="n">String</span><span class="o">[]</span> <span class="n">permissions</span><span class="o">,</span>
</span><span class='line'>                                           <span class="nd">@NonNull</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">grantResults</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">requestCode</span> <span class="o">==</span> <span class="n">ACCESS_LOCATION_PERMISSION_REQUEST_CODE</span><span class="o">){</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">verifyPermissions</span><span class="o">(</span><span class="n">grantResults</span><span class="o">)){</span>
</span><span class='line'>                <span class="c1">//perform the action</span>
</span><span class='line'>                <span class="n">acquireLocation</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
</span><span class='line'>                <span class="n">Snackbar</span><span class="o">.</span><span class="na">make</span><span class="o">(</span><span class="n">mainLayout</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">cannot_access_location</span><span class="o">,</span> <span class="n">Snackbar</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">verifyPermissions</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">grantResults</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// At least one result must be checked.</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">grantResults</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Verify that each required permission has been granted, otherwise return false.</span>
</span><span class='line'>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">result</span> <span class="o">:</span> <span class="n">grantResults</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">PackageManager</span><span class="o">.</span><span class="na">PERMISSION_GRANTED</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code won&rsquo;t work becuase the <code>verifyPermissions</code> returns false!</p>

<p>According to the definition of <a href="https://developer.android.com/training/permissions/requesting.html">permission group</a></p>

<blockquote><p>The user only needs to grant permission once for each permission group. If your app requests any other permissions in that group (that are listed in your app manifest), the system automatically grants them.</p></blockquote>

<p>What they miss is that once the group permission is granted, the grant results for other permission in one group must be <code>PackageManager.PERMISSION_DENIED</code>.</p>

<p>However, you cannot put one representative permission when you request access for the permission group, as Google clearly claims</p>

<blockquote><p>Your app still needs to explicitly request every permission it needs, even if the user has already granted another permission in the same group. In addition, the grouping of permissions into groups may change in future Android releases. Your code should not rely on the assumption that particular permissions are or are not in the same group.</p></blockquote>

<p>In conclusion, you shall never trust the <code>grantResults</code> and always check the permission one by one.</p>

<h2>Alternative</h2>

<p>Apparently Google recommends app not to ask for permission if unnecessary. However if the app does not have the <code>CAMERA</code> permission, it cannot fire intent to get the default app running. We are not sure if this is a bug or not.</p>

<h2>Threading</h2>

<p>Our demo app shows that it is fine to check the permission on background thread as long as you have a context. However, you cannot ask for permission without an activity as the API available is</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">requestPermissions</span> <span class="o">(</span><span class="n">Activity</span> <span class="n">activity</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">permissions</span><span class="o">,</span> <span class="kt">int</span> <span class="n">requestCode</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>You need an <strong>activity</strong> to ask for permissions.</p>

<p>Additionally, it is possible to call <code>requestPermission()</code> on the background thread and the dialog will show up. However since the result will reach you via the callback <code>onRequestPermissionsResult</code> on main thread,  you shall avoid calling the <code>requestPermission</code> on background thread to avoid nasty threading issue.</p>

<h2>Upgrade Strategy</h2>

<p>Initially we believe Google will take the approach like other 3rd party ROM does: if you don&rsquo;t get the permission, you will get nothing back and the UI moves on. However it is not the case. If you don&rsquo;t have the access the location, query the location API will break the app.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">SecurityException</span><span class="o">:</span> <span class="s">&quot;network&quot;</span> <span class="n">location</span> <span class="n">provider</span> <span class="n">requires</span> <span class="n">ACCESS_COARSE_LOCATION</span> <span class="n">or</span> <span class="n">ACCESS_FINE_LOCATION</span> <span class="n">permission</span><span class="o">.</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span><span class="o">.</span><span class="na">readException</span><span class="o">(</span><span class="n">Parcel</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1599</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span><span class="o">.</span><span class="na">readException</span><span class="o">(</span><span class="n">Parcel</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1552</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">location</span><span class="o">.</span><span class="na">ILocationManager</span><span class="n">$Stub$Proxy</span><span class="o">.</span><span class="na">requestLocationUpdates</span><span class="o">(</span><span class="n">ILocationManager</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">606</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">location</span><span class="o">.</span><span class="na">LocationManager</span><span class="o">.</span><span class="na">requestLocationUpdates</span><span class="o">(</span><span class="n">LocationManager</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">880</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">location</span><span class="o">.</span><span class="na">LocationManager</span><span class="o">.</span><span class="na">requestLocationUpdates</span><span class="o">(</span><span class="n">LocationManager</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">464</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">garena</span><span class="o">.</span><span class="na">hellomarshmallow</span><span class="o">.</span><span class="na">HomeActivity</span><span class="o">.</span><span class="na">acquireLocation</span><span class="o">(</span><span class="n">HomeActivity</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">63</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">garena</span><span class="o">.</span><span class="na">hellomarshmallow</span><span class="o">.</span><span class="na">HomeActivity</span><span class="o">.</span><span class="na">access</span><span class="n">$000</span><span class="o">(</span><span class="n">HomeActivity</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">15</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">garena</span><span class="o">.</span><span class="na">hellomarshmallow</span><span class="o">.</span><span class="na">HomeActivity</span><span class="n">$1</span><span class="o">.</span><span class="na">onClick</span><span class="o">(</span><span class="n">HomeActivity</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">35</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">view</span><span class="o">.</span><span class="na">View</span><span class="o">.</span><span class="na">performClick</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">5198</span><span class="o">)</span>
</span><span class='line'>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">view</span><span class="o">.</span><span class="na">View</span><span class="n">$PerformClick</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">21147</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This forces us to rethink whether we should make app target to the latest SDK version.</p>

<ul>
<li>Don&rsquo;t target to API level 23 if you are not ready</li>
<li>Feel free to update the SDK but keep the <code>targetSdkVersion</code> to 22 or lower</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">android</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">compileSdkVersion</span> <span class="mi">23</span>
</span><span class='line'>    <span class="n">buildToolsVersion</span> <span class="s">&quot;23.0.1&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">defaultConfig</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">applicationId</span> <span class="s">&quot;com.garena.hellomarshmallow&quot;</span>
</span><span class='line'>        <span class="n">minSdkVersion</span> <span class="mi">15</span>
</span><span class='line'>        <span class="n">targetSdkVersion</span> <span class="mi">22</span>
</span><span class='line'>        <span class="n">versionCode</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">versionName</span> <span class="s">&quot;1.0&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this case, you will find all required permissions granted by default.</p>

<p><img src="/images/permission-api-22.png" alt="Permission Granted" /></p>

<p>However, we shall have <strong>NO</strong> excuse keeping this configuration as user can turn off the permission if they determine to do so.</p>

<h2>The Most Challenging Part</h2>

<p>Engineers need to convince the product managers that you need to invest a huge amount of time on something not a feature.</p>

<p>This is not a feature, but a death sentence in the near future.</p>

  
  
</div><!-- /.entry-content -->





</article><!-- /.hentry -->

<article class="hentry">
  



<header>
  <div class="entry-meta">
    <span class="entry-date date published updated">
      <time datetime="2015-05-24T11:37:22+08:00">
        <a href="/blog/2015/05/24/a-shot-of-espresso/">May 24, 2015</a>
      </time>
    </span>
    <span class="author vcard">
      <span class="fn">
        <a href="zhao-cong" title="About Zhao Cong">Zhao Cong</a>
      </span>
    </span>
    
      &nbsp; &bull; &nbsp;<span class="entry-comments">
        <a href="/blog/2015/05/24/a-shot-of-espresso/#disqus_thread">Comment</a>
      </span>
    
  </div><!-- /.entry-meta -->
  
    <h1 class="entry-title">
      <a href="/blog/2015/05/24/a-shot-of-espresso/" rel="bookmark" title="A Shot of Espresso" itemprop="url">A Shot of Espresso</a>
    </h1>
  
</header>

<div class="entry-content">
  <p>The days without testing in Garena is long gone.  Our QA team has done a great job to provide continuous integration for BeeTalk and now it is the time for the engineering team to catch up.  So we set time aside to explore the continuous integration for our new Project.  Apparently Google has promoted <a href="https://code.google.com/p/android-test-kit/wiki/Espresso">Espresso</a> as the official framework for Android integration testing and it becomes our choice without second thought.</p>

<h2>Configuration</h2>

<p>We found Espresso easy to set up and the integration is just smooth. Add the dependency to <code>build.gradle</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">androidTestCompile</span><span class="o">(</span><span class="err">&#39;</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">test</span><span class="o">.</span><span class="na">espresso</span><span class="o">:</span><span class="n">espresso</span><span class="o">-</span><span class="nl">core:</span><span class="mf">2.1</span><span class="err">&#39;</span><span class="o">){</span>
</span><span class='line'>    <span class="n">exclude</span> <span class="nl">group:</span> <span class="err">&#39;</span><span class="n">javax</span><span class="o">.</span><span class="na">inject</span><span class="err">&#39;</span> <span class="c1">//support 2.3</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">androidTestCompile</span> <span class="err">&#39;</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">test</span><span class="o">.</span><span class="na">espresso</span><span class="o">:</span><span class="n">espresso</span><span class="o">-</span><span class="nl">intents:</span><span class="mf">2.1</span><span class="err">&#39;</span>
</span><span class='line'><span class="n">androidTestCompile</span> <span class="err">&#39;</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">test</span><span class="o">.</span><span class="na">espresso</span><span class="o">:</span><span class="n">espresso</span><span class="o">-</span><span class="nl">contrib:</span><span class="mf">2.1</span><span class="err">&#39;</span>
</span><span class='line'><span class="n">androidTestCompile</span> <span class="err">&#39;</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">test</span><span class="o">:</span><span class="nl">runner:</span><span class="mf">0.2</span><span class="err">&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>For Android studio, simply create a new test configuration and it is all set.</p>

<p><img src="/images/espresso.png" alt="Espresso Configuration" /></p>

<p>Of course, you shall put all your test cases in <code>/src/androidTest</code>.</p>

<h2>Write test cases</h2>

<p>We are interested to write test cases to cover basic user operation, including login, registration and purchase, in which many network requests are involved.  We aim to achieve three things:</p>

<ul>
<li>Robust:  test cases should always work</li>
<li>Lightweight:  zero impact or trivial modification to production code</li>
<li>Efficient:  lower down the cost to run the test cases</li>
</ul>


<h4>Robustness</h4>

<p>Our test cases are designed to cover the workflow with expected execution in mind.  Since we cannot run the logic without networking interaction, we decide to mock every single network request via our request wrapper.  For example, <code>TokenLoginRequest</code> is our class wrapper to fire a login request.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TokenLoginRequest</span> <span class="kd">extends</span> <span class="n">EndpointHttpRequest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">String</span> <span class="n">mMobileNumber</span><span class="o">,</span> <span class="n">mToken</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">TokenLoginRequest</span><span class="o">(</span><span class="n">OkHttpClient</span> <span class="n">httpClient</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">super</span><span class="o">(</span><span class="n">httpClient</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLoginInfo</span><span class="o">(</span><span class="n">String</span> <span class="n">mobile</span><span class="o">,</span> <span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">mMobileNumber</span> <span class="o">=</span> <span class="n">mobile</span><span class="o">;</span>
</span><span class='line'>        <span class="n">mToken</span> <span class="o">=</span> <span class="n">token</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">protected</span> <span class="n">RequestBody</span> <span class="nf">body</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">FormEncodingBuilder</span><span class="o">().</span>
</span><span class='line'>                <span class="n">add</span><span class="o">(</span><span class="s">&quot;token&quot;</span><span class="o">,</span> <span class="n">mToken</span><span class="o">).</span>
</span><span class='line'>                <span class="n">add</span><span class="o">(</span><span class="s">&quot;mobile&quot;</span><span class="o">,</span> <span class="n">mMobileNumber</span><span class="o">).</span>
</span><span class='line'>                <span class="n">build</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getServiceName</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s">&quot;services2/login/token/&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To mock it, simply override the implementation</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MockTokenLoginRequest</span> <span class="kd">extends</span> <span class="n">TokenLoginRequest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Gson</span> <span class="n">gson</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Gson</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">MockTokenLoginRequest</span><span class="o">(</span><span class="n">OkHttpClient</span> <span class="n">httpClient</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">super</span><span class="o">(</span><span class="n">httpClient</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Response</span> <span class="nf">execute</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">CommonResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CommonResponse</span><span class="o">();</span>
</span><span class='line'>        <span class="n">response</span><span class="o">.</span><span class="na">errorCode</span> <span class="o">=</span> <span class="n">NetworkConst</span><span class="o">.</span><span class="na">OK</span><span class="o">;</span>
</span><span class='line'>        <span class="n">response</span><span class="o">.</span><span class="na">errorMessage</span> <span class="o">=</span> <span class="s">&quot;ok&quot;</span><span class="o">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">ResponseFactory</span><span class="o">.</span><span class="na">getJsonResponseBuilder</span><span class="o">(</span><span class="n">gson</span><span class="o">.</span><span class="na">toJson</span><span class="o">(</span><span class="n">response</span><span class="o">),</span> <span class="n">postRequest</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>With mocked API request, there is no way to fail a case due to unstable WIFI network. How to put the mock class in action? There are two ways, either via a factory class or perform injection. We utilize Dagger and define test modules to replace the default implementation</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">loginViaOtp</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">();</span>
</span><span class='line'>    <span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">&quot;number_ui&quot;</span><span class="o">,</span> <span class="n">MockOTPValidationRequest</span><span class="o">.</span><span class="na">STANDARD_LOGIN</span><span class="o">);</span>
</span><span class='line'>    <span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">&quot;number_e164&quot;</span><span class="o">,</span> <span class="n">MockOTPValidationRequest</span><span class="o">.</span><span class="na">STANDARD_LOGIN</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">mActivityRule</span><span class="o">.</span><span class="na">launchActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//input the sms</span>
</span><span class='line'>    <span class="n">onView</span><span class="o">(</span><span class="n">withId</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">cp_sms_code_input</span><span class="o">)).</span><span class="na">perform</span><span class="o">(</span><span class="n">typeText</span><span class="o">(</span><span class="s">&quot;111111&quot;</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//inject the fake sms authentication</span>
</span><span class='line'>    <span class="n">LoginSMSAuthActivity</span> <span class="n">smsAuthActivity</span> <span class="o">=</span> <span class="o">(</span><span class="n">LoginSMSAuthActivity</span><span class="o">)</span> <span class="n">getActivityInstance</span><span class="o">();</span>
</span><span class='line'>    <span class="n">mockModule</span><span class="o">.</span><span class="na">inject</span><span class="o">(</span><span class="n">smsAuthActivity</span><span class="o">.</span><span class="na">presenter</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//click the button</span>
</span><span class='line'>    <span class="n">onView</span><span class="o">(</span><span class="n">withId</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">cp_sms_confirm_btn</span><span class="o">)).</span><span class="na">perform</span><span class="o">(</span><span class="n">click</span><span class="o">());</span>
</span><span class='line'>    <span class="c1">//....</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You may not have the chance to perform the injection so easily due to complicated hierarchy but it is essential to keep the footprint small. In test cases, I really don&rsquo;t mind playing dirty tricks like reflection.</p>

<h3>Lightweight</h3>

<p>Test cases cannot pose any issue to the production code.  Gradle has offered great flexibility on how to separate debug code and production code, so does the case of testing.</p>

<h4>Code Strucure</h4>

<p><code>/src/androidTest</code></p>

<ul>
<li>hold all test cases</li>
<li>supporting library</li>
</ul>


<p><code>/src/debug</code></p>

<ul>
<li>mock classes</li>
</ul>


<p><code>/src/release</code></p>

<ul>
<li>no mocking classes</li>
</ul>


<h4>Injection</h4>

<p>As stated above, we provide mock implementation via injection but sometimes it is not that straight forward. In those case in which you have to inject the fake implementation at the early stage of the activity life cycle, we simply override the activity and inject as early as possible. In other cases, you may not want the navigation happen because you cannot inject an activity which does not exist.  The code snippet below shows how we handle both cases.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestLoginActivity</span> <span class="kd">extends</span> <span class="n">LoginActivity</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">ActivityScreenSwitcher</span> <span class="n">mScreenSwitcher</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreateComponent</span><span class="o">(</span><span class="n">AppComponent</span> <span class="n">appComponent</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">//use the real app module</span>
</span><span class='line'>        <span class="n">AppModule</span> <span class="n">module</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AppModule</span><span class="o">(</span><span class="n">CyberpayAdminApp</span><span class="o">.</span><span class="na">getApp</span><span class="o">());</span>
</span><span class='line'>        <span class="n">DebugAppUIModule</span> <span class="n">uiModule</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DebugAppUIModule</span><span class="o">();</span>
</span><span class='line'>        <span class="c1">//get the real login session</span>
</span><span class='line'>        <span class="n">UserModule</span> <span class="n">userModule</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserModule</span><span class="o">(</span><span class="n">CyberpayAdminApp</span><span class="o">.</span><span class="na">getApp</span><span class="o">().</span><span class="na">component</span><span class="o">().</span><span class="na">getLoginSession</span><span class="o">());</span>
</span><span class='line'>        <span class="c1">//customized app component</span>
</span><span class='line'>        <span class="n">DebugAppComponent</span> <span class="n">debugAppComponent</span> <span class="o">=</span> <span class="n">DaggerDebugAppComponent</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">appModule</span><span class="o">(</span><span class="n">module</span><span class="o">).</span><span class="na">userModule</span><span class="o">(</span><span class="n">userModule</span><span class="o">)</span>
</span><span class='line'>                <span class="o">.</span><span class="na">debugAppUIModule</span><span class="o">(</span><span class="n">uiModule</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">mScreenSwitcher</span> <span class="o">=</span> <span class="n">debugAppComponent</span><span class="o">.</span><span class="na">activityScreenSwitcher</span><span class="o">();</span>
</span><span class='line'>        <span class="n">mActivityComponent</span> <span class="o">=</span> <span class="n">DaggerMockRoutineComponent</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">appComponent</span><span class="o">(</span><span class="n">debugAppComponent</span><span class="o">).</span>
</span><span class='line'>                        <span class="n">mockRoutineModule</span><span class="o">(</span><span class="k">new</span> <span class="n">MockRoutineModule</span><span class="o">()).</span><span class="na">build</span><span class="o">();</span>
</span><span class='line'>        <span class="c1">//perform the injection with mock implementation</span>
</span><span class='line'>        <span class="n">mActivityComponent</span><span class="o">.</span><span class="na">inject</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="c1">//......</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>mActivitiyComponent</code> will be used to inject everything inside the activity, i.e. views, presenters and we provide <code>DebugAppUIModule</code> to intercept the intent for navigation and save for verification. In the test cases, you should invoke <code>TestLoginActivity</code> instead of <code>LoginActivity</code>.  At the first sight it looks scary, because even new <strong>hacked</strong> activities are introduced. Well, there is no chance to have them in the production because you shall have everything under the flavor of <code>debug</code>.</p>

<h4>Async Trick</h4>

<p>People always wonder how to test something asynchronous from the user perspective, i.e fire a network request and the activity moves to the next step. Espresso supports <code>AsyncTask</code> in its core implementation and offers flexibility to other async/task management framework. <a href="https://github.com/BoltsFramework/Bolts-Android">Bolts</a> is our choice of task management and our code is structured like this</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">mContinueBtn</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="k">new</span> <span class="n">View</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                <span class="nd">@Override</span>
</span><span class='line'>                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">View</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">getView</span><span class="o">().</span><span class="na">showLoading</span><span class="o">();</span>
</span><span class='line'>                    <span class="n">mLoginRequest</span><span class="o">.</span><span class="na">setNumber</span><span class="o">(</span><span class="n">input</span><span class="o">);</span>
</span><span class='line'>                    <span class="n">Task</span><span class="o">.</span><span class="na">callInBackground</span><span class="o">(</span><span class="k">new</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">LoginInfo</span><span class="o">&gt;()</span> <span class="o">{</span>
</span><span class='line'>                          <span class="nd">@Override</span>
</span><span class='line'>                          <span class="kd">public</span> <span class="n">LoginInfo</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>                                <span class="c1">//make the request</span>
</span><span class='line'>                                <span class="k">return</span> <span class="n">mLoginRequest</span><span class="o">.</span><span class="na">getResponse</span><span class="o">();</span>
</span><span class='line'>                          <span class="o">}</span>
</span><span class='line'>                    <span class="o">}).</span><span class="na">continueWith</span><span class="o">(</span><span class="k">new</span> <span class="n">Continuation</span><span class="o">&lt;</span><span class="n">LoginInfo</span><span class="o">,</span> <span class="n">Void</span><span class="o">&gt;()</span> <span class="o">{</span>
</span><span class='line'>                          <span class="nd">@Override</span>
</span><span class='line'>                          <span class="kd">public</span> <span class="n">Void</span> <span class="nf">then</span><span class="o">(</span><span class="n">Task</span><span class="o">&lt;</span><span class="n">LoginInfo</span><span class="o">&gt;</span> <span class="n">task</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>                                 <span class="n">getView</span><span class="o">().</span><span class="na">loadingView</span><span class="o">.</span><span class="na">setRefreshing</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span><span class='line'>                                 <span class="k">if</span> <span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">isFaulted</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>                                     <span class="n">activity</span><span class="o">.</span><span class="na">resolveError</span><span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">getError</span><span class="o">());</span>
</span><span class='line'>                               <span class="o">}</span>
</span><span class='line'>                                 <span class="c1">//perform action </span>
</span><span class='line'>                                 <span class="c1">//......</span>
</span><span class='line'>                                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>                    <span class="o">},</span> <span class="n">Task</span><span class="o">.</span><span class="na">UI_THREAD_EXECUTOR</span><span class="o">));</span>
</span><span class='line'>          
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>We follow the <a href="https://code.google.com/p/android-test-kit/wiki/EspressoSamples#Using_registerIdlingResource_to_synchronize_with_custom_resource">recommendation from Google</a> but later we found that <a href="http://developer.android.com/reference/android/support/test/espresso/IdlingResource.html">IdlingResource</a> is poorly documented.</p>

<blockquote><p><code>isIdleNow()</code> returns true if resource is currently idle. Espresso will always call this method from the main thread, therefore it should be non-blocking and return immediately.</p></blockquote>

<p>You may ask why I should care about this. Well, here is the core idea behind this helper class. The system will check on it time by time after registration. Assume you have a state variable <code>mIsBusy</code> and <code>isIdleNow</code> will return the value of <code>mIsBusy</code>, you should always modify the value <code>mIsBusy</code> from the main thread, otherwise there is no guarantee that the test runner will stop before the asynchronous call completed.  Ideally, you shall have test case like this</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">loginTest</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//attempt login </span>
</span><span class='line'>    <span class="n">onView</span><span class="o">(</span><span class="n">withId</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">login_button</span><span class="o">)).</span><span class="na">perform</span><span class="o">(</span><span class="n">click</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//FIRE NETWORK REQUEST......</span>
</span><span class='line'>    <span class="c1">//WAIT UNTIL THE SERVER RETURNS THE RESULT</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//verify which activity it is now</span>
</span><span class='line'>    <span class="n">assertTrue</span><span class="o">(</span><span class="n">getActivityInstance</span><span class="o">()</span> <span class="k">instanceof</span> <span class="n">HomeActivity</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You cannot change the <code>mIsBusy</code> before you click the login button, otherwise nobody will trigger the login action. You cannot change the value after the login button because you don&rsquo;t know when the network response will modify the value.  It seems to be a deadlock and the solution is to change the value right after the user clicks the button.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">mContinueBtn</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="k">new</span> <span class="n">View</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                <span class="nd">@Override</span>
</span><span class='line'>                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">View</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>                    <span class="c1">//MODIFY THE mIsBusy FROM MAIN THREAD</span>
</span><span class='line'>                    <span class="n">mIsBusy</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>                   <span class="c1">//fire network request</span>
</span><span class='line'>                <span class="o">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>A static variable cannot serves well for multiple network requests in sequence (they cannot decide when to flip the value). Additionally the production code should be unaware of <code>IdlingResource</code> presence.  Thus we comes with a helper class in <code>main</code> sources.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NetworkStatus</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">long</span> <span class="n">mStartTime</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">mCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * Mark a new checkpoint of background requests, must call via UI thread.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">onNetworkRequestStart</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">BuildConfig</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">NetworkStatus</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mCount</span><span class="o">++;</span>
</span><span class='line'>            <span class="n">mStartTime</span> <span class="o">=</span> <span class="n">BBTimeHelper</span><span class="o">.</span><span class="na">millNow</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * Mark a new checkpoint of background requests, recommend to call via UI thread but not necessary to do so</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">onNetworkRequestEnd</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">BuildConfig</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">NetworkStatus</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mCount</span><span class="o">--;</span>
</span><span class='line'>            <span class="n">BBAppLogger</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">&quot;execution time %d&quot;</span><span class="o">,</span> <span class="n">BBTimeHelper</span><span class="o">.</span><span class="na">millNow</span><span class="o">()</span> <span class="o">-</span> <span class="n">mStartTime</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * Accessed via UI thread only</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @return true if no network task is ongoing</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isIdle</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">mCount</span> <span class="o">==</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>and subclass the <code>IdlingResource</code> in <code>androidTest</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NetworkIdlingResource</span> <span class="kd">implements</span> <span class="n">IdlingResource</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s">&quot;network_mock&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isIdleNow</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="kt">boolean</span> <span class="n">idle</span> <span class="o">=</span> <span class="n">NetworkStatus</span><span class="o">.</span><span class="na">isIdle</span><span class="o">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">idle</span> <span class="o">&amp;&amp;</span> <span class="n">mCallback</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mCallback</span><span class="o">.</span><span class="na">onTransitionToIdle</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">idle</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">ResourceCallback</span> <span class="n">mCallback</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerIdleTransitionCallback</span><span class="o">(</span><span class="n">ResourceCallback</span> <span class="n">resourceCallback</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">mCallback</span> <span class="o">=</span> <span class="n">resourceCallback</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Thus the production code should call <code>NetworkStatus.onNetworkRequestStart</code> from main thread before firing a network request and call <code>NetworkStatus.onNetworkRequestEnd</code> from main thread after a network requests completes.  Trivial modification is made and goal accomplished.</p>

<h3>Efficient</h3>

<p>Android fragmentation scares people and many developers only test their application on physical devices. Ironically, most of bugs are caused by logic errors rather than device variance.  We choose Genymotion for continuous integration with <a href="https://jenkins-ci.org/">Jenkins</a>. Here is the setup</p>

<ul>
<li>Ubuntu 14.04 LTS on a lower end Dell laptop</li>
<li>3 Genymotion instances (Android 4.3, 4.4, 5.1)</li>
<li>Connect to Jenkins machine with direct cable</li>
</ul>


<p>Genymotion is much faster than physical devices and the three instance can fire concurrently. 63 tests can finish with 3 minutes.</p>

<p><img src="/images/jenkins_espresso.png" alt="Espresso with Jenkins" /></p>

<p>You can add as many VM or physical devices as you want and trigger the testing via</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="o">./</span><span class="n">gradlew</span> <span class="n">connectedAndroidTestDebug</span>
</span></code></pre></td></tr></table></div></figure>


<p> ## Conclusion
Our journey with Espresso or continuous integration does not end here and we are working on a couple of things like</p>

<ul>
<li>write test cases against our server API</li>
<li>apply espresso to test shared libraries</li>
<li>test upon different flavors</li>
</ul>


  
  
</div><!-- /.entry-content -->





</article><!-- /.hentry -->

<article class="hentry">
  



<header>
  <div class="entry-meta">
    <span class="entry-date date published updated">
      <time datetime="2015-05-19T17:15:10+08:00">
        <a href="/blog/2015/05/19/powered-by-dagger-2/">May 19, 2015</a>
      </time>
    </span>
    <span class="author vcard">
      <span class="fn">
        <a href="zhao-cong" title="About Zhao Cong">Zhao Cong</a>
      </span>
    </span>
    
      &nbsp; &bull; &nbsp;<span class="entry-comments">
        <a href="/blog/2015/05/19/powered-by-dagger-2/#disqus_thread">Comment</a>
      </span>
    
  </div><!-- /.entry-meta -->
  
    <h1 class="entry-title">
      <a href="/blog/2015/05/19/powered-by-dagger-2/" rel="bookmark" title="Powered by Dagger 2" itemprop="url">Powered by Dagger 2</a>
    </h1>
  
</header>

<div class="entry-content">
  <p>There are a lots of buzz about Android architecture recently. We feel excited about the evolvement of Android development and decide to give a try for production. After a few trials and errors, we are settled with the combination of <a href="http://google.github.io/dagger/">Dagger 2</a> and <a href="https://code.google.com/p/android-test-kit/wiki/Espresso">Espresso</a>. We feel happy with it and would like to share our experience with Dagger 2 in this post.</p>

<h2>Pros</h2>

<p>We start with <a href="http://square.github.io/dagger/">Dagger 1</a> from Square and loves the concept. It is a brand new way for us to get rid of ugly singleton pattern and structure the code in an elegant manner.  Additionally, it fundamentally resolves the issues of dependency and acquiring resource is not an problem any more.</p>

<p>Later we learn about the even awesome <code>Dagger 2</code>, it immediately catches our attention for those features we actually cares. The code generation avoids the tricks of reflection and fixed class naming, thus 100% friendly to proguard. Nevertheless, developers still have to decide how to structure the code. The great flexibility is prone to over engineering and eventually you will find a deadlock when attempting to run unit tests. Dependency injection brings the advantage of data mocking and we start with simple use case.</p>

<h3>Dagger for Development</h3>

<p>Assume you want to initiate a Http request after the user clicks a button. The code below shows how it works without dependency injection.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="n">LoginRequest</span> <span class="n">mRequest</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@onClick</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">login</span><span class="o">)</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">loginButtonOnClicked</span><span class="o">(){</span>
</span><span class='line'>   <span class="n">Task</span><span class="o">.</span><span class="na">callInBackGround</span> <span class="o">{</span>
</span><span class='line'>     <span class="n">Response</span> <span class="n">rp</span> <span class="o">=</span> <span class="n">mRequest</span><span class="o">.</span><span class="na">post</span><span class="o">()</span>
</span><span class='line'> <span class="o">}.</span> <span class="n">onSuccess</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">//Update the UI</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It is very straight forward, but using the production server or testing server is slow and you may hit limited number of login per day etc. Dagger saves our lives by <code>Qualifier</code>. To start with, you define a qualifier to distinguish implementation for production and internal testing.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>   <span class="nd">@Qualifier</span>
</span><span class='line'>   <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
</span><span class='line'>   <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">MockMode</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">String</span> <span class="nf">value</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;&quot;</span><span class="o">;</span>  <span class="c1">//true/false</span>
</span><span class='line'>   <span class="o">}</span>   
</span></code></pre></td></tr></table></div></figure>


<p>Then you can provide different implementation based on the qualifier.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MockLoginRequest</span> <span class="kd">extends</span> <span class="n">LoginRequest</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">//skip the network call and fake the result</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Provides</span>
</span><span class='line'>    <span class="nd">@MockMode</span><span class="o">(</span><span class="s">&quot;mock&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="n">LoginRequest</span> <span class="nf">getMockLoginRequest</span><span class="o">(</span><span class="n">OkHttpClient</span> <span class="n">httpClient</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">MockLoginRequest</span><span class="o">(</span><span class="n">httpClient</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Provides</span>
</span><span class='line'>    <span class="nd">@MockMode</span><span class="o">(</span><span class="s">&quot;prod&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="n">LoginRequest</span> <span class="nf">getPasscodeRequest</span><span class="o">(</span><span class="n">OkHttpClient</span> <span class="n">httpClient</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">LoginRequest</span><span class="o">(</span><span class="n">httpClient</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you want to fire the fake <code>LoginRequest</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@MockMode</span><span class="o">(</span><span class="s">&quot;mock&quot;</span><span class="o">)</span> 
</span><span class='line'><span class="kd">private</span> <span class="n">LoginRequest</span> <span class="n">mRequest</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>or you want to connect to the real server</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@MockMode</span><span class="o">(</span><span class="s">&quot;prod&quot;</span><span class="o">)</span> 
</span><span class='line'><span class="kd">private</span> <span class="n">LoginRequest</span> <span class="n">mRequest</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>In any case, you should not have debug code in production and Dagger is right there to offer the hand with gradle flavor.  You shall always have the definition <code>MockLoginRequest</code> in the debug flavor and define two modules in <code>release</code> and <code>debug</code> flavor.</p>

<p>Only the production code will go into the <code>release</code> module.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="nd">@Provides</span>
</span><span class='line'>    <span class="nd">@MockMode</span><span class="o">(</span><span class="s">&quot;prod&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="n">LoginRequest</span> <span class="nf">getInitPasscodeRequest</span><span class="o">(</span><span class="n">OkHttpClient</span> <span class="n">httpClient</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">LoginRequest</span><span class="o">(</span><span class="n">httpClient</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Offer more choice in debug flavor only.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>
</span><span class='line'><span class="nd">@Provides</span>
</span><span class='line'><span class="nd">@MockMode</span><span class="o">(</span><span class="s">&quot;mock&quot;</span><span class="o">)</span>
</span><span class='line'><span class="n">LoginRequest</span> <span class="nf">getMockLoginRequest</span><span class="o">(</span><span class="n">OkHttpClient</span> <span class="n">httpClient</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nf">MockLoginRequest</span><span class="o">(</span><span class="n">httpClient</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Provides</span>
</span><span class='line'><span class="nd">@MockMode</span><span class="o">(</span><span class="s">&quot;prod&quot;</span><span class="o">)</span>
</span><span class='line'><span class="n">LoginRequest</span> <span class="nf">getInitPasscodeRequest</span><span class="o">(</span><span class="n">OkHttpClient</span> <span class="n">httpClient</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nf">LoginRequest</span><span class="o">(</span><span class="n">httpClient</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you misuse the qualifier, the compilation will fail and you will immediately know that something goes wrong.</p>

<h3>Dig Deeper</h3>

<p>You need to structure the code around Dagger. Generally we have</p>

<ul>
<li><code>AppComponent</code>: base component for sub components</li>
<li><code>AppModule</code>: provides application context</li>
<li><code>UserModule</code>: provides user information, i.e. <code>LoginSession</code></li>
<li><code>NetworkModule</code>:  provides implementation of network class, i.e <code>OkHttpClient</code>,<code>Gson</code></li>
<li><code>UIModule</code>:  provides implementation for naviagtion</li>
<li>Activity specific modules: provides domain related resources, i.e. <code>LoginRequest</code>, <code>PurcahseRequest</code></li>
</ul>


<figure class='code'><figcaption><span>AppComponent.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@ApplicationScope</span>
</span><span class='line'><span class="nd">@Component</span><span class="o">(</span>
</span><span class='line'>        <span class="n">modules</span> <span class="o">=</span> <span class="o">{</span><span class="n">AppModule</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">NetworkModule</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">AppUIModule</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">UserModule</span><span class="o">.</span><span class="na">class</span><span class="o">}</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AppComponent</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>       <span class="n">Gson</span> <span class="nf">getGson</span><span class="o">();</span>
</span><span class='line'>       <span class="c1">//other implementation</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In sub components, utilize the domain-related module for injection</p>

<figure class='code'><figcaption><span>HomeModule.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Module</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HomeModule</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Provides</span>
</span><span class='line'>    <span class="nd">@MockMode</span><span class="o">(</span><span class="s">&quot;prod&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="n">GetUserInfoRequest</span> <span class="nf">getUserInfoRequest</span><span class="o">(</span><span class="n">OkHttpClient</span> <span class="n">httpClient</span><span class="o">,</span> <span class="n">Gson</span> <span class="n">gson</span><span class="o">,</span> <span class="n">LoginSession</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">GetUserInfoRequest</span><span class="o">(</span><span class="n">httpClient</span><span class="o">,</span> <span class="n">gson</span><span class="o">,</span> <span class="n">session</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//offer other modules</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Quote the module in the component</p>

<figure class='code'><figcaption><span>HomeComponent.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@HomeScope</span>
</span><span class='line'><span class="nd">@Component</span><span class="o">(</span>
</span><span class='line'>        <span class="n">dependencies</span> <span class="o">=</span> <span class="o">{</span><span class="n">AppComponent</span><span class="o">.</span><span class="na">class</span><span class="o">},</span>
</span><span class='line'>        <span class="n">modules</span> <span class="o">=</span> <span class="o">{</span><span class="n">HomeModule</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">HomeComponent</span> <span class="o">{</span>
</span><span class='line'>    <span class="kt">void</span> <span class="nf">inject</span><span class="o">(</span><span class="n">HomeActivity</span> <span class="n">activity</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So when can we get hold of the component and perform the injection?</p>

<p>You definitely want everything ready before the resource is needed. The activity component should be created at the very beginning of the activity life cycle, i.e. <code>onCreate</code> for <code>Activity</code> and the activity performs the injection to views or UI presenters immediately after their new birth. As you may be aware, there are two ways of injection, either injection via constructor or injection via annotation. In general, we favor injection via annotation due to flexibility.</p>

<h3>Even Better in Testing</h3>

<p>Dagger brings much more flexibility to testing as you can easily swap the implementation via injection. For simple structure, as long as you can grab the reference to the object, you can perform injection.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>        <span class="c1">//input the sms</span>
</span><span class='line'>        <span class="n">onView</span><span class="o">(</span><span class="n">withId</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">cp_sms_code_input</span><span class="o">)).</span><span class="na">perform</span><span class="o">(</span><span class="n">typeText</span><span class="o">(</span><span class="s">&quot;111111&quot;</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//inject the fake sms authentication</span>
</span><span class='line'>        <span class="n">LoginSMSAuthActivity</span> <span class="n">smsAuthActivity</span> <span class="o">=</span> <span class="o">(</span><span class="n">LoginSMSAuthActivity</span><span class="o">)</span> <span class="n">getActivityInstance</span><span class="o">();</span>
</span><span class='line'>        <span class="n">mockModule</span><span class="o">.</span><span class="na">inject</span><span class="o">((</span><span class="n">LoginSMSAuthActivity</span><span class="o">.</span><span class="na">UIPresenter</span><span class="o">)</span> <span class="n">smsAuthActivity</span><span class="o">.</span><span class="na">presenter</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//click the button</span>
</span><span class='line'>        <span class="n">onView</span><span class="o">(</span><span class="n">withId</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">cp_sms_confirm_btn</span><span class="o">)).</span><span class="na">perform</span><span class="o">(</span><span class="n">click</span><span class="o">());</span>
</span></code></pre></td></tr></table></div></figure>


<p>The combination of Dagger and Espresso is just awesome but it is never short of work around and fixes. We shall talk more about this topic in the next post.</p>

<h2>Cons</h2>

<h3>More Methods</h3>

<p>Dagger will increase the method count without grace. If you find the size of dex is growing out of control due to massive feature requirement, do think twice before triggering the magic of code generation.</p>

<h3>No Second Chance</h3>

<p><code>Volley</code> is interchangeable with <code>OkHttp</code>, you can always switch implementation if one outperforms another. However,  once you design the app around <code>Dagger</code>, you have to stick to it since there is no alternative available to replace the code structure. Vice versa, it is going to take enormous effort to adapt Dagger half way. In other words, you have to make your mind when you start the project.</p>

  
  
</div><!-- /.entry-content -->





</article><!-- /.hentry -->

<article class="hentry">
  



<header>
  <div class="entry-meta">
    <span class="entry-date date published updated">
      <time datetime="2014-09-10T16:35:45+08:00">
        <a href="/blog/2014/09/10/android-memory-leaks/">September 10, 2014</a>
      </time>
    </span>
    <span class="author vcard">
      <span class="fn">
        <a href="" title="About "></a>
      </span>
    </span>
    
      &nbsp; &bull; &nbsp;<span class="entry-comments">
        <a href="/blog/2014/09/10/android-memory-leaks/#disqus_thread">Comment</a>
      </span>
    
  </div><!-- /.entry-meta -->
  
    <h1 class="entry-title">
      <a href="/blog/2014/09/10/android-memory-leaks/" rel="bookmark" title="Memory Leaks in Android" itemprop="url">Memory Leaks in Android</a>
    </h1>
  
</header>

<div class="entry-content">
  <h2>What is a Memory Leak?</h2>

<p>Memory leak is existence of objects in the memory, that are not needed anymore according to the application logic, but still retain memory and cannot be collected because they are referenced from other live objects, due to a bug in application itself. When the program runs for an extended time and consumes additional memory over time, it can diminish the performance of the system by reducing the amount of available memory. Eventually, in the worst case, too much of the available memory may become allocated and the system may run &ldquo;<a href="https://developer.android.com/reference/java/lang/OutOfMemoryError.html">out of memory (OOM)</a>&rdquo;.</p>

<h2>Understanding Memory Leaks</h2>

<p>To understand memory leaks in Android and how they may happen, let&rsquo;s first start with a simple example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HomeActivity</span> <span class="kd">extends</span> <span class="n">BBBaseActivity</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">HomeView</span> <span class="n">view</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HomeView</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class='line'>        <span class="n">setContentView</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">new</span> <span class="nf">SampleTask</span><span class="o">().</span><span class="na">execute</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">SampleTask</span> <span class="kd">extends</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">,</span> <span class="n">Void</span><span class="o">,</span> <span class="n">Void</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">protected</span> <span class="n">Void</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="n">Void</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="c1">// do nothing</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code simply starts an <code>AsyncTask</code> when the activity is created. You could have similar code which may start the task when a button is clicked. What if I told you this code can cause potential memory leak! It is not obvious now (because we haven&rsquo;t really done anything in the background).</p>

<p>What if we add some code to the <code>doInBackground()</code> method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HomeActivity</span> <span class="kd">extends</span> <span class="n">BBBaseActivity</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">HomeView</span> <span class="n">view</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HomeView</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class='line'>        <span class="n">setContentView</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">new</span> <span class="nf">SampleTask</span><span class="o">().</span><span class="na">execute</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">SampleTask</span> <span class="kd">extends</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">,</span> <span class="n">Void</span><span class="o">,</span> <span class="n">Void</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">private</span> <span class="kt">long</span> <span class="n">mStartTime</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPreExecute</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mStartTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">protected</span> <span class="n">Void</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="n">Void</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">doBackgroundWork</span><span class="o">();</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">doBackgroundWork</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="kt">long</span> <span class="n">timeNow</span><span class="o">;</span>
</span><span class='line'>            <span class="k">do</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">timeNow</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span><span class='line'>                <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">timeNow</span> <span class="o">-</span> <span class="n">mStartTime</span> <span class="o">&lt;</span> <span class="o">(</span><span class="mi">1</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above code performs some background work. For demonstration, it simply runs in a while loop for <code>1 minute</code>.  This is a fair sample because some tasks may be used for image downloading, file reading etc, which could take some time. Let&rsquo;s run this code and analyze the memory for leaks using <a href="http://android-developers.blogspot.sg/2011/03/memory-analysis-for-android.html">Memory Analyzer Toolkit (MAT)</a>.</p>

<p><img src="/images/leak.png" alt="Memory Analysis using MAT" /></p>

<p>As we can see in the picture above, there are multiple instances of the <code>HomeActivity</code> in the memory which are retained and not garbage collected. After running the above code, try rotating the screen multiple times, or close and launch the activity again a few times. Once the activity is destroyed and recreated, the old instance is still in the memory and is not cleared (even though the activity has been destroyed and is not needed by the application or code logic anymore). Recall, this is what we call <strong>memory leak</strong>.</p>

<h3>Why are the old instances of home activity not cleared?</h3>

<p>At the fundamental level, old instances are not cleared even after the activity is destroyed because <em>&ldquo;someone&rdquo;</em> is keeping a reference to it. This <em>&ldquo;someone&rdquo;</em> is our <code>AsyncTask</code>.  Because we define our <code>AsyncTask</code> as a non-static inner class, it keeps an explicit reference to the parent class (<code>HomeActivity</code>). The <code>AsyncTask</code> will be in the memory (and not be garbage collected) until it has finished execution. So even though the activity has been destroyed, the <code>AsyncTask</code> keeps a reference to it, which prevents the activity instance from getting cleared.</p>

<h3>When <code>AsyncTask</code> completes, the references will be cleared, so why is it a problem?</h3>

<p>This is a problem because it can cause your app to run <em>&ldquo;out of memory&rdquo;</em> and crash. Android system allocates a certain maximum amount of memory to each app. If the app&rsquo;s memory usage exceeds the maximum allocated <em>heap size</em>, <a href="https://developer.android.com/training/articles/memory.html">the application will thow OOM and crash</a>. Having unwanted objects in the memory that are not timely cleared can cause the application to run out of memory. Imagine, if your activity keeps references to bitmaps, large buffers or other objects, there will be multiple copies of them in the memory. This will increase the RAM usage substantially. Before there is a chance for all references to get cleared, the app may run out of memory and crash.</p>

<h3>How can we resolve this issue?</h3>

<p>To answer this, lets see what is the fundamental problem.:</p>

<blockquote><p>The <code>AsycTask</code> is keeping reference to the <code>HomeActivity</code> which prevents it from being cleared.</p></blockquote>

<p>We can ask ourselves:</p>

<ol>
<li> Does the <code>AsyncTask</code> need to keep a reference to the <code>HomeActivity</code>?</li>
<li>If it does, how can we make sure that this reference is automatically cleared when we are sure we don&rsquo;t need it anymore?</li>
</ol>


<p>In the above case, the <code>AsyncTask</code> does not need to keep a reference to the activity as it is not accessing any parent members. We could resolve the issue by simply declaring the <code>AsyncTask</code> as a <strong><code>static nested</code></strong> class or in a different class file altogether. This ensures that they not keep a reference to the parent class. (In case you are wondering, <a href="http://www.programmerinterview.com/index.php/java-questions/inner-vs-nested-classes/">here is the difference between inner class and nested class</a>?)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HomeActivity</span> <span class="kd">extends</span> <span class="n">BBBaseActivity</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">HomeView</span> <span class="n">view</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HomeView</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class='line'>        <span class="n">setContentView</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">new</span> <span class="nf">SampleTask</span><span class="o">().</span><span class="na">execute</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SampleTask</span> <span class="kd">extends</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">,</span> <span class="n">Void</span><span class="o">,</span> <span class="n">Void</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">private</span> <span class="kt">long</span> <span class="n">mStartTime</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPreExecute</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mStartTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">protected</span> <span class="n">Void</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="n">Void</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">doBackgroundWork</span><span class="o">();</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">doBackgroundWork</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="kt">long</span> <span class="n">timeNow</span><span class="o">;</span>
</span><span class='line'>            <span class="k">do</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">timeNow</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span><span class='line'>                <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">timeNow</span> <span class="o">-</span> <span class="n">mStartTime</span> <span class="o">&lt;</span> <span class="o">(</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">));</span>
</span><span class='line'>            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;TASK&quot;</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We run this code, perform the same operations as before, rotate screen few times, close re-open activity etc. This time we observer that there are multiple instances of the <code>AsyncTask</code> in the memory but not multiple instances of the <code>HomeActivity</code>.</p>

<p><img src="/images/leak-fix.png" alt="Memory Analysis using MAT" /></p>

<p>This method does not work always. In some cases, we need to perform certain UI operation after the <code>AsycTask</code> completes, in which case we are required to keep a reference to the <code>Activity</code> or <code>View</code>. Now we simply need to make sure that this reference is <code>weak</code> in nature so that it is automatically cleared by the system once the <code>Activity</code> or <code>View</code> are destroyed. For this we can make use of Java <a href="https://weblogs.java.net/blog/2006/05/04/understanding-weak-references"><code>WeakReference&lt;T&gt;</code></a> class as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HomeActivity</span> <span class="kd">extends</span> <span class="n">BBBaseActivity</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">HomeView</span> <span class="n">view</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HomeView</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class='line'>        <span class="n">setContentView</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">new</span> <span class="nf">SampleTask</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SampleTask</span> <span class="kd">extends</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">,</span> <span class="n">Void</span><span class="o">,</span> <span class="n">Void</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">private</span> <span class="kt">long</span> <span class="n">mStartTime</span><span class="o">;</span>
</span><span class='line'>        <span class="kd">private</span> <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">HomeActivity</span><span class="o">&gt;</span> <span class="n">mRef</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">public</span> <span class="nf">SampleTask</span><span class="o">(</span><span class="n">HomeActivity</span> <span class="n">activity</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mRef</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">HomeActivity</span><span class="o">&gt;(</span><span class="n">activity</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPreExecute</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mStartTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">protected</span> <span class="n">Void</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="n">Void</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">doBackgroundWork</span><span class="o">();</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">doBackgroundWork</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="kt">long</span> <span class="n">timeNow</span><span class="o">;</span>
</span><span class='line'>            <span class="k">do</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">timeNow</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span><span class='line'>                <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">timeNow</span> <span class="o">-</span> <span class="n">mStartTime</span> <span class="o">&lt;</span> <span class="o">(</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="n">Void</span> <span class="n">aVoid</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">HomeActivity</span> <span class="n">activity</span> <span class="o">=</span> <span class="n">mRef</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">activity</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// the activity reference was cleared, </span>
</span><span class='line'>                <span class="c1">// lets forget about it</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// lets update the activity with the results</span>
</span><span class='line'>                <span class="c1">// of the task</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And hence we are able to write code which is memory efficient and less likely to make the system run out of memory.</p>

<h1>Other Leak Scenarios</h1>

<p>Now that we understand what memory leak is, let us explore some other ways we can end up in similar leak situations:</p>

<h3>1) Anonymous Inner Classes</h3>

<p>Java provides syntax for creating <code>inner</code> classes on the fly which do not have a name.  Lets take a look at an example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/*Pay attention to the opening curly braces</span>
</span><span class='line'><span class="cm">  and the fact that there&#39;s a semicolon</span>
</span><span class='line'><span class="cm">  at the very end, once the anonymous class is created:</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'><span class="n">DownloadCallback</span> <span class="n">mCallback</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DownloadCallback</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">//code here...</span>
</span><span class='line'><span class="o">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>These <a href="http://www.programmerinterview.com/index.php/java-questions/java-anonymous-class-example/"><code>anonymous inner</code></a> classes have the same problem as we discussed above. Each keeps a reference to the instance of the <code>parent</code> class which initialized it. This means that if you pass around the <code>mCallback</code> object (in the above case), you may end up with a memory leak. Let&rsquo;s see that with an example:</p>

<p>We have a <code>FileManager</code> which downloads files. It is implemented as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FileManager</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="n">FileManager</span> <span class="n">mInstance</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="n">FileManager</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">mInstance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mInstance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileManager</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">mInstance</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">FileManager</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">mCallbackQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayDeque</span><span class="o">&lt;</span><span class="n">DownloadCallback</span><span class="o">&gt;();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">ArrayDeque</span><span class="o">&lt;</span><span class="n">DownloadCallback</span><span class="o">&gt;</span> <span class="n">mCallbackQueue</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">download</span><span class="o">(</span><span class="n">String</span> <span class="n">fileId</span><span class="o">,</span> <span class="n">DownloadCallback</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">mCallbackQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">callback</span><span class="o">);</span>
</span><span class='line'>        <span class="c1">// ..</span>
</span><span class='line'>        <span class="c1">// do the download</span>
</span><span class='line'>        <span class="c1">// ..</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we perform file download from our <code>Activity</code> or <code>View</code> as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HomeActivity</span> <span class="kd">extends</span> <span class="n">BBBaseActivity</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">HomeView</span> <span class="n">view</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HomeView</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class='line'>        <span class="n">setContentView</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">FileManager</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">download</span><span class="o">(</span><span class="s">&quot;file1&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">DownloadCallback</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="nd">@Override</span>
</span><span class='line'>            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDownloadComplete</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// download has been completed</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We have a <strong>&ldquo;memory leak&rdquo;</strong>. Since the <code>FileManager</code> is a <code>singleton</code> it will be in the memory for the lifetime of the application. The download callback is passed to this <code>singleton</code> and stored within <code>mCallbackQueue</code>. This means that there is a reference to the <code>mCallback</code> object from a <code>static</code> object in the memory.</p>

<blockquote><p>This means that for every callback object in the <code>mCallbackQueue</code>, its associated <code>parent</code> class will not get cleared from the memory.</p></blockquote>

<p>If we remove the callback from the <code>mCallbackQueue</code> after the download completes, there are still problems as the download may take a while to finish. In the mean-time the user may have scrolled away or navigated to a new screen. Other downloads may have been put into the queue. Before all downloads complete, the system may go out of memory and crash.</p>

<blockquote><p>Lesson: Avoid passing <code>anonymous inner</code> class objects to static / singleton classes which keep a strong reference to it.</p></blockquote>

<p>To resolve this issue:</p>

<ol>
<li>We can follow the same logic we used in the case of the <code>AsyncTask</code></li>
<li>Alternatively, we could make our singleton hold <code>WeakReference</code> to the callbacks instead:</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FileManager</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="n">FileManager</span> <span class="n">mInstance</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="n">FileManager</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">mInstance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mInstance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileManager</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">mInstance</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">FileManager</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">mCallbackQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayDeque</span><span class="o">&lt;</span><span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">DownloadCallback</span><span class="o">&gt;&gt;();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">ArrayDeque</span><span class="o">&lt;</span><span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">DownloadCallback</span><span class="o">&gt;&gt;</span> <span class="n">mCallbackQueue</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">download</span><span class="o">(</span><span class="n">String</span> <span class="n">fileId</span><span class="o">,</span> <span class="n">DownloadCallback</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">mCallbackQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">DownloadCallback</span><span class="o">&gt;(</span><span class="n">callback</span><span class="o">));</span>
</span><span class='line'>        <span class="c1">// ..</span>
</span><span class='line'>        <span class="c1">// do the download</span>
</span><span class='line'>        <span class="c1">// ..</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In Java<code>inner</code> classes are a handy construct. The key is to understand how they work and ensure that they are not used (or rather &ldquo;overused&rdquo;) in situations that can critically impact the memory.</p>

<p>For more references:</p>

<ul>
<li><a href="http://www.curious-creature.org/2008/12/18/avoid-memory-leaks-on-android/">http://www.curious-creature.org/2008/12/18/avoid-memory-leaks-on-android/</a></li>
<li><a href="http://evendanan.net/2013/02/Android-Memory-Leaks-OR-Different-Ways-to-Leak/">http://evendanan.net/2013/02/Android-Memory-Leaks-OR-Different-Ways-to-Leak/</a></li>
<li><a href="https://developer.android.com/training/articles/memory.html">https://developer.android.com/training/articles/memory.html</a></li>
</ul>


  
  
</div><!-- /.entry-content -->





</article><!-- /.hentry -->

<article class="hentry">
  



<header>
  <div class="entry-meta">
    <span class="entry-date date published updated">
      <time datetime="2014-07-18T14:40:33+08:00">
        <a href="/blog/2014/07/18/android-prevent-webview-from-memory-leak/">July 18, 2014</a>
      </time>
    </span>
    <span class="author vcard">
      <span class="fn">
        <a href="" title="About Xiang Yongzhou">Xiang Yongzhou</a>
      </span>
    </span>
    
      &nbsp; &bull; &nbsp;<span class="entry-comments">
        <a href="/blog/2014/07/18/android-prevent-webview-from-memory-leak/#disqus_thread">Comment</a>
      </span>
    
  </div><!-- /.entry-meta -->
  
    <h1 class="entry-title">
      <a href="/blog/2014/07/18/android-prevent-webview-from-memory-leak/" rel="bookmark" title="Android Prevent Webview From Memory Leak" itemprop="url">Android Prevent Webview From Memory Leak</a>
    </h1>
  
</header>

<div class="entry-content">
  <p>In Android app development, webview is widely used.  However, if you are using webview without caution, it will easily consume a lot of memory.  And your app may even crash due to insufficient memory.</p>

<p>The memory issue of webview is well-known, here are two great links about the issue.</p>

<p><a href="http://stackoverflow.com/questions/3130654/memory-leak-in-webview">Post in English</a></p>

<p><a href="http://my.oschina.net/zhibuji/blog/100580">Post in Chinese</a></p>

<p>For Android  4.4 and above, Android is using chromium as the core of webview. For Android 3.1 to 4.3, Android is using webkit as the core of webview. Most of the memory leak happens on webkit.</p>

<p>And the blog will briefly summarize the tips to prevent webview memory leak</p>


  
  
    <footer>
      <a class="btn" rel="full-article" href="/blog/2014/07/18/android-prevent-webview-from-memory-leak/">Read on &rarr;</a>
    </footer>
  
</div><!-- /.entry-content -->





</article><!-- /.hentry -->

<article class="hentry">
  



<header>
  <div class="entry-meta">
    <span class="entry-date date published updated">
      <time datetime="2014-07-18T13:33:30+08:00">
        <a href="/blog/2014/07/18/what-works-for-us-so-far-ormlite/">July 18, 2014</a>
      </time>
    </span>
    <span class="author vcard">
      <span class="fn">
        <a href="zhao-cong" title="About Zhao Cong">Zhao Cong</a>
      </span>
    </span>
    
      &nbsp; &bull; &nbsp;<span class="entry-comments">
        <a href="/blog/2014/07/18/what-works-for-us-so-far-ormlite/#disqus_thread">Comment</a>
      </span>
    
  </div><!-- /.entry-meta -->
  
    <h1 class="entry-title">
      <a href="/blog/2014/07/18/what-works-for-us-so-far-ormlite/" rel="bookmark" title="What Works for Us So Far - Ormlite" itemprop="url">What Works for Us So Far - Ormlite</a>
    </h1>
  
</header>

<div class="entry-content">
  <h3><a href="http://ormlite.com/sqlite_java_android_orm.shtml">Ormlite</a></h3>

<p>Ormlite is the our choice of database ORM. Although we have decided to stick to it for new Android applications, there are quite a few thing missing in the manual.</p>

<h3>Name the Database</h3>

<p>Normally you name the databas with user ID like this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">String</span> <span class="n">databaseName</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;user_%d.db&quot;</span><span class="o">,</span> <span class="n">mUserId</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then you are screwed because you don&rsquo;t speak Persian/Arabian. In some languages, you cannot expect one as <code>1</code> and this <a href="http://en.wikipedia.org/wiki/Eastern_Arabic_numerals">wiki post</a> will show you a new way to write numbers. You can reproduce this issue by switching the locale to Arabic on the phone and you must stay clam if the app cannot find the database. The fix is simple, just specify the locale when formatting the string.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">String</span> <span class="n">databaseName</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">Locale</span><span class="o">.</span><span class="na">ENGLISH</span><span class="o">,</span><span class="s">&quot;user_%d.db&quot;</span><span class="o">,</span> <span class="n">mUserId</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>



  
  
    <footer>
      <a class="btn" rel="full-article" href="/blog/2014/07/18/what-works-for-us-so-far-ormlite/">Read on &rarr;</a>
    </footer>
  
</div><!-- /.entry-content -->





</article><!-- /.hentry -->

<article class="hentry">
  



<header>
  <div class="entry-meta">
    <span class="entry-date date published updated">
      <time datetime="2014-07-13T17:15:15+08:00">
        <a href="/blog/2014/07/13/what-works-for-us-so-far-volley/">July 13, 2014</a>
      </time>
    </span>
    <span class="author vcard">
      <span class="fn">
        <a href="zhao-cong" title="About Zhao Cong">Zhao Cong</a>
      </span>
    </span>
    
      &nbsp; &bull; &nbsp;<span class="entry-comments">
        <a href="/blog/2014/07/13/what-works-for-us-so-far-volley/#disqus_thread">Comment</a>
      </span>
    
  </div><!-- /.entry-meta -->
  
    <h1 class="entry-title">
      <a href="/blog/2014/07/13/what-works-for-us-so-far-volley/" rel="bookmark" title="What Works for Us So Far - Volley" itemprop="url">What Works for Us So Far - Volley</a>
    </h1>
  
</header>

<div class="entry-content">
  <p>There are quite a few open source projects which aims to accelerate Android application development. For example,
<a href="http://java.dzone.com/articles/how-become-lazy-productive">this series</a> is a great summary on how to be &ldquo;lazy productive&rdquo;. All of those frameworks or tools look great at the first sight but they may screw up you when you drive deeper and deeper.</p>

<p>To help you guys to make better decision, we want to share our experience and today let&rsquo;s starts with <a href="https://android.googlesource.com/platform/frameworks/volley/">Volley</a> from Google.</p>

<h3><a href="https://android.googlesource.com/platform/frameworks/volley/">Volley</a></h3>

<p>Volley debuts in Google IO last year and we fall in love with it quickly. It provides a complete set of toolkit to download anything via HTTP protocol. In addition to the general file download framework, it shows us a great example on how to download and process the images. With Volley, you don&rsquo;t need to worry about</p>

<ul>
<li>Establish the connection</li>
<li>How to handle HTTP files</li>
<li>How to handle the images</li>
<li>Can extend to download anything</li>
</ul>



  
  
    <footer>
      <a class="btn" rel="full-article" href="/blog/2014/07/13/what-works-for-us-so-far-volley/">Read on &rarr;</a>
    </footer>
  
</div><!-- /.entry-content -->





</article><!-- /.hentry -->

<article class="hentry">
  



<header>
  <div class="entry-meta">
    <span class="entry-date date published updated">
      <time datetime="2014-07-10T21:02:09+08:00">
        <a href="/blog/2014/07/10/who-we-are/">July 10, 2014</a>
      </time>
    </span>
    <span class="author vcard">
      <span class="fn">
        <a href="zhao-cong" title="About Zhao Cong">Zhao Cong</a>
      </span>
    </span>
    
      &nbsp; &bull; &nbsp;<span class="entry-comments">
        <a href="/blog/2014/07/10/who-we-are/#disqus_thread">Comment</a>
      </span>
    
  </div><!-- /.entry-meta -->
  
    <h1 class="entry-title">
      <a href="/blog/2014/07/10/who-we-are/" rel="bookmark" title="Who We Are" itemprop="url">Who We Are</a>
    </h1>
  
</header>

<div class="entry-content">
  <p>We are the code monkeys in Garena.</p>

<p>As Android developers, we have learnt a lot from the online community, otherwise we cannot reach this far today.</p>

<p>We would like to start blogging about what makes us strong and what we feel proud of.</p>

<p><img src="/images/logo-garena.gif" alt="alt-text" /></p>

  
  
</div><!-- /.entry-content -->





</article><!-- /.hentry -->


<div class="pagination">
  
  <a href="/archives">Blog Archives</a>
  
</div><!-- /.pagination -->

  </div><!-- /#main -->

  <div class="footer-wrapper">
    <footer role="contentinfo">
      <span>&copy; 2015 Garena Labs. Powered by <a href="http://octopress.org">Octopress</a> using the <a href="https://github.com/Z1MM32M4N/hpstr-theme/">HPSTR Theme for Octopress</a>.</span>

    </footer>
  </div><!-- /.footer-wrapper -->

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/javascripts/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<!--
<script src="/javascripts/octopress.js" type="text/javascript"></script>
-->
<script src="/javascripts/scripts.min.js"></script>

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-53779472-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>



          
  

</body>
</html>
